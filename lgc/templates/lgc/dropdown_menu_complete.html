{% load i18n %}
{% load custom_tags %}
{% load humanize %}

{% now "Y-m-d" as today %}
{% get_notification_menu request as notifs %}
{% get_process_progress request as process_progress %}
<ul class="nav navbar-nav ml-md-auto flex-row navbar-top-links bg-light">

  {% include 'lgc/dropdown_menu_lang.html' %}

  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle nav-link" data-toggle="dropdown" href="#" role="button"
       aria-haspopup="true" aria-expanded="false">
      <i class="fa fa-tasks fa-fw"></i>
    </a>

    <div class="dropdown-menu dropdown-menu-right dropdown-tasks" style="width:400px;">
      {% for p in process_progress %}
      <a class="dropdown-item" href="{{ p.5 }}">
        <div>
          <p>
            <strong>{{ p.0 }} {{ p.1 }}{{ p.2 }}</strong>
            <span class="float-right text-muted">{{ p.3 }}%</span>
          </p>
          <div class="progress active">
            <div class="progress-bar progress-bar-striped progress-bar-animated {{ p.4 }}"
                 role="progressbar" aria-valuenow="{{ p.3 }}" aria-valuemin="0" aria-valuemax="100"
                 style="width: {{ p.3 }}%">
              <span class="sr-only">{{ p.3 }}%</span>
            </div>
          </div>
        </div>
      </a>
      <div class="dropdown-divider"></div>
      {% endfor %}
      <strong class="dropdown-item see-more text-center">
	{% if process_progress|length %}
	{% trans 'Pending processes' %}
	{% else %}
	{% trans 'No pending processes' %}
	{% endif %}
      </strong>
      <!--a class="dropdown-item see-more text-center" href="#">
        <strong>{% trans 'See all pending processes' %}</strong>
        <i class="fa fa-angle-right"></i>
      </a-->
    </div>
  </li>

  <li class="nav-item dropdown">
    <a class="nav-link dropdown-toggle nav-link" data-toggle="dropdown" href="#" role="button"
       aria-haspopup="true" aria-expanded="false">
      <i class="far fa-bell fa-fw"></i>
      {% if notifs.nb_items > 0 and notifs.nb_items < 100 %}
      <span class="notification">{{ notifs.nb_items }}</span>
      {% elif notifs.nb_items > 100 %}
      <span class="notification">+99</span>
      {% endif %}
    </a>
    <div class="dropdown-menu dropdown-menu-right dropdown-alerts" style="width:400px;">

      {% for e in notifs.expirations %}
      <a class="dropdown-item" href="{% url 'lgc-file' e.person.id %}">
        <div>
          <i class="fa fa-hourglass-end fa-fw"></i>
	  {% with name=e.person.first_name|add:' '|add:e.person.last_name line_length=e.person.first_name %}
	  {{ name|truncatechars:19 }}
	  {% endwith %}
	  <span class="float-right text-muted small">
	    {% get_expiration_mapping e.type as e_mapping %}
	    {{ e_mapping }}
	    {% if e.end_date|date:'Y-m-d' < today %}
	    {% trans 'expired' %}
	    {% else %}
	    {% trans 'expires in' %}
	    {% if e.end_date|timeuntil|wordcount > 2 %}
	    {{ e.end_date|timeuntil|truncatewords:2|slice:":-3" }}
	    {% else %}
	    {{ e.end_date|timeuntil }}
	    {% endif %}
	    {% endif %}
	  </span>
        </div>
      </a>
      <div class="dropdown-divider"></div>
      {% endfor %}

      <a class="dropdown-item see-more text-center" href="{% url 'lgc-expirations' %}">
        <strong>{% trans 'See All Expirations' %}</strong>
        <i class="fa fa-angle-right"></i>
      </a>
    </div>
  </li>
  {% include 'lgc/dropdown_menu_users.html' %}
</ul>
